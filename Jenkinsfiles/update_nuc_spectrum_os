#!groovy

buildResults = [:]

pipeline {
    agent { label 'tc-agent02' }
    stages {
        stage('Change USB HUB host to PC') {
            steps {
            	script{
                  sh './AcronameHubCLI -u 0'
                  // wait that USB drive is mounted
                  sh 'sleep 10'
                  def output = sh (
                      script: 'lsblk -o model,name |grep PSSD',
                      returnStdout: true
                      ).trim()
                  def list = output.split(' ')
                  // Take last element which is the target USB device
                  USBDEVICE = list[-1]
                  println("USB device: ${USBDEVICE}")
               }
            }
        }
        stage('Write Spectrum OS image to USB disk') {
            steps {
              dir('/home/tc-agent02/Jenkins-agent/workspace/NixCopyTest/'){
                sh "sudo dd if=${params.FILENAME} of=/dev/sdb bs=1M status=progress conv=fsync"
               }
            }
        }
        stage('Change USB HUB host back to test device') {
            steps {
              script{
                  sh './AcronameHubCLI -u 1'
               }
            }
        }
    }
}
